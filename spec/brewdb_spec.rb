require 'rspec'
require './spec_helper'
require './lib/brew_db'
 
describe BrewDB do
  before :each do
    @brewdb = BrewDB.new
  end
  
  describe "new" do
    it "creates a BrewDB object" do
      ENV['brewdbkey'] = "fakekey"
      brewdb = BrewDB.new
      brewdb.should be_an_instance_of BrewDB
    end
    
    it "should raise an error if no key info is found" do
      ENV['brewdbkey'] = nil
      YAML.should_receive(:load).and_return(nil)
      lambda { BrewDB.new }.should raise_error(RuntimeError, "Unable to contact API - no key provided")
    end
  end
  
  describe "get_brewery_info" do    
    it "should return full info given a valid id" do
      RestClient.should_receive(:get).and_return("{\"breweries\":{\"brewery\":{\"id\":\"3283\",\"name\":\"Camden Town Brewery\",\"description\":\"Welcome to Camden Town Brewery. London now has it's very own craft beer and as the name suggests, it's being brewed in Camden. Using only the freshest ingredients and no brain aching chemicals, we'll be brewing lager, wheat beer and pale ale. The best city in the world deserves the best beer and now it's right in your backyard.\",\"established\":\"2011\",\"address\":{\"street_address\":\"55-58 Wilkin Street Mews\",\"extended-address\":\"\",\"locality\":\"London\",\"region\":\"\",\"postal_code\":\"NW5 3NN\",\"country_name\":\"GB\"},\"phone\":\"0207 485 1671\",\"website\":\"http:\\/\\/www.camdentownbrewery.com\\/\",\"created\":\"2012-01-28T04:38:33+00:00\",\"updated\":\"\"}}}")
      @brewdb.get_brewery_info("3283").should == {"id"=>"3283", "name"=>"Camden Town Brewery", "description"=>"Welcome to Camden Town Brewery. London now has it's very own craft beer and as the name suggests, it's being brewed in Camden. Using only the freshest ingredients and no brain aching chemicals, we'll be brewing lager, wheat beer and pale ale. The best city in the world deserves the best beer and now it's right in your backyard.", "established"=>"2011", "address"=>{"street_address"=>"55-58 Wilkin Street Mews", "extended-address"=>"", "locality"=>"London", "region"=>"", "postal_code"=>"NW5 3NN", "country_name"=>"GB"}, "phone"=>"0207 485 1671", "website"=>"http://www.camdentownbrewery.com/", "created"=>"2012-01-28T04:38:33+00:00", "updated"=>""}
    end
    
    it "should return a blank hash in the event of an error" do
      RestClient.stub(:get).and_raise(RestClient::ResourceNotFound)
      @brewdb.get_brewery_info("fake_id").should == {}
    end
  end
  
  describe "find_brewery_by_name" do    
    it "should return a single result if there is only one result" do
      RestClient.should_receive(:get).and_return("{\"results\":{\"result\":{\"id\":\"3283\",\"name\":\"Camden Town Brewery\",\"type\":\"Brewery\",\"relavance\":\"100%\"},\"pages\":{\"page\":\"1\",\"total\":\"1\"}}}")
      @brewdb.find_brewery_by_name("Camden").should == [{"id" => "3283", "name" => "Camden Town Brewery", "type" => "Brewery", "relavance" => "100%"}]
    end
    
    it "should return a single result if there is an exact name match" do
      RestClient.should_receive(:get).and_return("{\"results\":{\"result\":[{\"id\":\"3283\",\"name\":\"Camden Town Brewery\",\"type\":\"Brewery\",\"relavance\":\"100%\"},{\"id\":\"3281\",\"name\":\"Lucky Town Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"17%\"},{\"id\":\"1905\",\"name\":\"Mountain Town Station Brew Pub\",\"type\":\"Brewery\",\"relavance\":\"15%\"},{\"id\":\"869\",\"name\":\"Minneapolis Town Hall Brewery\",\"type\":\"Brewery\",\"relavance\":\"9%\"},{\"id\":\"1208\",\"name\":\"Stonecutters Brewhouse\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"2643\",\"name\":\"Intercourse Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"2281\",\"name\":\"CooperSmith's Pub & Brewing\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1793\",\"name\":\"Von Scheidt Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"2799\",\"name\":\"WelznGarnr\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1965\",\"name\":\"BAR\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"2061\",\"name\":\"Chicago Beer Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"2104\",\"name\":\"Austin Beerworks\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"2510\",\"name\":\"Hub City Brewing Co\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1271\",\"name\":\"Tommyknocker Brewery\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"2299\",\"name\":\"Burley Oak Craft Brewery\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1421\",\"name\":\"Kern River Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1908\",\"name\":\"Odd Side Ales\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"147\",\"name\":\"Bobcat Cafe & Brewery\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"241\",\"name\":\"BrewDog Ltd\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"343\",\"name\":\"Carlow Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"868\",\"name\":\"Minhas Craft Brewery\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"69\",\"name\":\"Baltimore-Washington Beer Works\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"657\",\"name\":\"High Point Wheat Beer Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"956\",\"name\":\"Oskar Blues Brewery\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1009\",\"name\":\"Port Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1788\",\"name\":\"Keweenaw Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1977\",\"name\":\"Urban Chestnut Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"757\",\"name\":\"Kulmbacher Brauerei AG\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"2219\",\"name\":\"Bertrams Salmon Valley Brewery\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"2246\",\"name\":\"Cathedral Square Brewery\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"3114\",\"name\":\"Southern Hops Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"2211\",\"name\":\"Battlefield Brewing Co\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"2755\",\"name\":\"Loop Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"919\",\"name\":\"North Coast Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"901\",\"name\":\"Nebraska Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1705\",\"name\":\"Wasatch Brewpub\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"35\",\"name\":\"Amherst Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"111\",\"name\":\"Bierbrouwerij St.Christoffel\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"140\",\"name\":\"Bloomington Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1516\",\"name\":\"Brewer's Alley Restaurant & Brewery\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1467\",\"name\":\"Creemore Spring Brewery\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"422\",\"name\":\"Cumberland Brewery\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1460\",\"name\":\"DC Brau Brewing\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1509\",\"name\":\"Ellicottville Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1877\",\"name\":\"Hideout Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1808\",\"name\":\"16 Mile Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"3245\",\"name\":\"College Street Brewhouse & Pub\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"3100\",\"name\":\"Snowy Mountain Brewery\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1548\",\"name\":\"Auburn Alehouse\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1419\",\"name\":\"Peace Tree Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"}],\"pages\":{\"page\":\"1\",\"total\":\"2\"}}}" )
      @brewdb.find_brewery_by_name("Camden Town Brewery").should == [{"id" => "3283", "name" => "Camden Town Brewery", "type" => "Brewery", "relavance" => "100%"}]
    end
    
    it "should return the first 5 results if there is no exact match" do
      RestClient.should_receive(:get).and_return("{\"results\":{\"result\":[{\"id\":\"3283\",\"name\":\"Camden Town Brewery\",\"type\":\"Brewery\",\"relavance\":\"100%\"},{\"id\":\"3281\",\"name\":\"Lucky Town Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"17%\"},{\"id\":\"1905\",\"name\":\"Mountain Town Station Brew Pub\",\"type\":\"Brewery\",\"relavance\":\"15%\"},{\"id\":\"869\",\"name\":\"Minneapolis Town Hall Brewery\",\"type\":\"Brewery\",\"relavance\":\"9%\"},{\"id\":\"1208\",\"name\":\"Stonecutters Brewhouse\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"2643\",\"name\":\"Intercourse Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"2281\",\"name\":\"CooperSmith's Pub & Brewing\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1793\",\"name\":\"Von Scheidt Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"2799\",\"name\":\"WelznGarnr\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1965\",\"name\":\"BAR\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"2061\",\"name\":\"Chicago Beer Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"2104\",\"name\":\"Austin Beerworks\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"2510\",\"name\":\"Hub City Brewing Co\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1271\",\"name\":\"Tommyknocker Brewery\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"2299\",\"name\":\"Burley Oak Craft Brewery\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1421\",\"name\":\"Kern River Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1908\",\"name\":\"Odd Side Ales\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"147\",\"name\":\"Bobcat Cafe & Brewery\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"241\",\"name\":\"BrewDog Ltd\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"343\",\"name\":\"Carlow Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"868\",\"name\":\"Minhas Craft Brewery\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"69\",\"name\":\"Baltimore-Washington Beer Works\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"657\",\"name\":\"High Point Wheat Beer Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"956\",\"name\":\"Oskar Blues Brewery\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1009\",\"name\":\"Port Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1788\",\"name\":\"Keweenaw Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1977\",\"name\":\"Urban Chestnut Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"757\",\"name\":\"Kulmbacher Brauerei AG\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"2219\",\"name\":\"Bertrams Salmon Valley Brewery\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"2246\",\"name\":\"Cathedral Square Brewery\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"3114\",\"name\":\"Southern Hops Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"2211\",\"name\":\"Battlefield Brewing Co\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"2755\",\"name\":\"Loop Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"919\",\"name\":\"North Coast Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"901\",\"name\":\"Nebraska Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1705\",\"name\":\"Wasatch Brewpub\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"35\",\"name\":\"Amherst Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"111\",\"name\":\"Bierbrouwerij St.Christoffel\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"140\",\"name\":\"Bloomington Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1516\",\"name\":\"Brewer's Alley Restaurant & Brewery\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1467\",\"name\":\"Creemore Spring Brewery\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"422\",\"name\":\"Cumberland Brewery\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1460\",\"name\":\"DC Brau Brewing\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1509\",\"name\":\"Ellicottville Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1877\",\"name\":\"Hideout Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1808\",\"name\":\"16 Mile Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"3245\",\"name\":\"College Street Brewhouse & Pub\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"3100\",\"name\":\"Snowy Mountain Brewery\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1548\",\"name\":\"Auburn Alehouse\",\"type\":\"Brewery\",\"relavance\":\"3%\"},{\"id\":\"1419\",\"name\":\"Peace Tree Brewing Company\",\"type\":\"Brewery\",\"relavance\":\"3%\"}],\"pages\":{\"page\":\"1\",\"total\":\"2\"}}}" )
      @brewdb.find_brewery_by_name("Camden Town").should == [{"name"=>"Camden Town Brewery", "id"=>"3283", "type"=>"Brewery", "relavance"=>"100%"}, {"name"=>"Lucky Town Brewing Company", "id"=>"3281", "type"=>"Brewery", "relavance"=>"17%"}, {"name"=>"Mountain Town Station Brew Pub", "id"=>"1905", "type"=>"Brewery", "relavance"=>"15%"}, {"name"=>"Minneapolis Town Hall Brewery", "id"=>"869", "type"=>"Brewery", "relavance"=>"9%"}, {"name"=>"Stonecutters Brewhouse", "id"=>"1208", "type"=>"Brewery", "relavance"=>"3%"}]
    end
    
    it "should return a blank array if there are no matches" do
      RestClient.should_receive(:get).and_return("{\"results\":{\"pages\":{\"page\":\"1\",\"total\":\"0\"}}}")
      @brewdb.find_brewery_by_name("Not found").should == []
    end
    
    it "should return a blank array if the API cannot be reached" do
      RestClient.stub(:get).and_raise(RestClient::ResourceNotFound)
      @brewdb.find_brewery_by_name("connect fail").should == []
    end
  end
  
  describe "list_beers_by_brewery_id" do
    it "should return a list of beers" do
      RestClient.stub(:get).and_return("{\"beers\":{\"beer\":[{\"id\":\"5735\",\"name\":\"(512) Wit\",\"description\":\"Made in the style of the Belgian wheat beers that are so refreshing, (512) Wit is a hazy ale spiced with coriander and domestic grapefruit peel. 50% US Organic 2-row malted barley and 50% US unmalted wheat and oats make this a light, crisp ale well suited for any occasion.\",\"brewery\":\"1\",\"metadata\":{\"srm\":\"\",\"available\":\"Year Round\",\"glassware\":\"5\",\"ibu\":\"\",\"abv\":\"5.2\",\"style\":\"55\",\"links\":{\"edit\":\"http:\\/\\/brewerydb.com\\/beer\\/edit\\/id\\/5735\",\"detail\":\"http:\\/\\/brewerydb.com\\/beer\\/info\\/id\\/5735\"}},\"created\":\"2010-12-21T05:10:04+00:00\",\"updated\":\"2011-04-04T14:49:09+00:00\"},{\"id\":\"5736\",\"name\":\"(512) Pale\",\"description\":\"With Organic 2-row malted barley, (512) Pale is a copper colored American Pale Ale that balances earthy hop bitterness and hop flavor with a rich malty body.\",\"brewery\":\"1\",\"metadata\":{\"srm\":\"\",\"available\":\"Year Round\",\"glassware\":\"5\",\"ibu\":\"\",\"abv\":\"5.8\",\"style\":\"33\",\"links\":{\"edit\":\"http:\\/\\/brewerydb.com\\/beer\\/edit\\/id\\/5736\",\"detail\":\"http:\\/\\/brewerydb.com\\/beer\\/info\\/id\\/5736\"}},\"created\":\"2010-12-21T05:10:04+00:00\",\"updated\":\"2011-04-04T14:57:03+00:00\"}]}}")
      @brewdb.list_beers_by_brewery_id("1").should == [{"name"=>"(512) Wit", "brewery"=>"1", "metadata"=>{"available"=>"Year Round", "glassware"=>"5", "srm"=>"", "ibu"=>"", "links"=>{"edit"=>"http://brewerydb.com/beer/edit/id/5735", "detail"=>"http://brewerydb.com/beer/info/id/5735"}, "style"=>"55", "abv"=>"5.2"}, "id"=>"5735", "description"=>"Made in the style of the Belgian wheat beers that are so refreshing, (512) Wit is a hazy ale spiced with coriander and domestic grapefruit peel. 50% US Organic 2-row malted barley and 50% US unmalted wheat and oats make this a light, crisp ale well suited for any occasion.", "updated"=>"2011-04-04T14:49:09+00:00", "created"=>"2010-12-21T05:10:04+00:00"}, {"name"=>"(512) Pale", "brewery"=>"1", "metadata"=>{"available"=>"Year Round", "glassware"=>"5", "srm"=>"", "ibu"=>"", "links"=>{"edit"=>"http://brewerydb.com/beer/edit/id/5736", "detail"=>"http://brewerydb.com/beer/info/id/5736"}, "style"=>"33", "abv"=>"5.8"}, "id"=>"5736", "description"=>"With Organic 2-row malted barley, (512) Pale is a copper colored American Pale Ale that balances earthy hop bitterness and hop flavor with a rich malty body.", "updated"=>"2011-04-04T14:57:03+00:00", "created"=>"2010-12-21T05:10:04+00:00"}]
    end
    
    it "should return an empty array if there are no beers for the given brewery" do
      RestClient.stub(:get).and_return("{\"beers\":{\"pages\":{\"page\":\"1\",\"total\":\"0\"}}}")
      @brewdb.list_beers_by_brewery_id("666").should == []
    end
    
    it "should return an empty array if there is an error" do
      RestClient.stub(:get).and_raise(RestClient::ResourceNotFound)
      @brewdb.list_beers_by_brewery_id("connect fail").should == []
    end
  end
end